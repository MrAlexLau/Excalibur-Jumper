<html>
<head></head>
<body>
How to play:
  <ul>
    <li>Try to jump and hit as many green blocks as possible.</li>
    <li>Press Space to jump.</li>
    <li>The longer you hold down space, the higher you jump.</li>
    <li>Use the left and right arrow keys to move while you're jumping.</li>
  <ul>

   <script type="text/javascript" src="bower_components/excalibur/dist/Excalibur.js"></script>
   <script type="text/javascript">
      var game = new ex.Engine(320, 480);
      game.backgroundColor = ex.Color.Black;
      var Goal = ex.Actor.extend({});

      var JUMPER_HEIGHT = 20;
      var JUMPER_WIDTH = 20;
      var ground = new ex.Actor(0, game.height - 100, game.width, 5, ex.Color.Yellow);
      ground.preventCollisions = true;
      var jumper = new ex.Actor(game.width / 2 - JUMPER_WIDTH / 2, ground.y, JUMPER_WIDTH, JUMPER_HEIGHT, ex.Color.Red);
      var jumpTimerStart, jumpAmount;
      var spacePushed = false;
      var chargeLabel = null;

      var score = 0;
      var scoreLabel = new ex.Label("Score: " + score, 5, 20);
      scoreLabel.font = '20px sans-serif';
      scoreLabel.color = ex.Color.Red;

      var chargeBars = [];

      jumper.rise = function(amount){
        jumper.y -= amount;
      }

      jumper.fall = function(amount){
        jumper.y += amount;
      }

      jumper.isOnGround = function(){
        return (jumper.y + 20 === ground.y);
      }

      jumper.addEventListener('collision', function(evt){
        if(evt.other instanceof Goal){
          score += 1;
          evt.other.kill();
          generateGoal();
        }
      });

      jumper.addEventListener('left', function(){
        if (!jumper.isOnGround() && jumper.x - 5 > -5) {
          jumper.x -= 5;
        }
      });

      jumper.addEventListener('right', function(){
        if (!jumper.isOnGround() && jumper.x + 5 < game.width - 5) {
          jumper.x += 5;
        }
      });

      jumper.addEventListener('keydown', function(evt){
        // if (evt.key == ex.InputKey.Space && jumper.isOnGround()){
        if (evt.key == ex.InputKey.Space){
          var d = new Date();
          jumpTimerStart = d.getTime();
          spacePushed = true;
        }
      });

      jumper.addEventListener('keyup', function(evt){
        if (evt.key == ex.InputKey.Space && jumper.isOnGround() && jumpTimerStart !== null){
          var d = new Date();
          var timeJumping = d.getTime() - jumpTimerStart;

          spacePushed = false;
          jumpAmount = timeJumping / 7;
          jumpTimerStart = null;

          chargeBars.forEach(function(bar){
            bar.kill();
          });
          chargeBars = [];
        }
      });

      function calcChargeBarYOffset(barArray){
        var offset = ground.y + JUMPER_HEIGHT;
        if (barArray.length > 0){
          offset = barArray[barArray.length - 1].y + 20;
        }

        return offset;
      }

      function randInt(lowerBound, upperBound){
        return Math.floor((Math.random() * upperBound) + lowerBound);
      }



      function generateGoal() {
        var goal = new Goal(randInt(0, game.width), randInt(0, ground.y - 10), JUMPER_WIDTH, JUMPER_HEIGHT, ex.Color.Green);
        game.addChild(goal);
      }

      game.addEventListener('update', function(evt){
        if (spacePushed && jumper.isOnGround()) {
          // console.log("" + jumper.y + ": " +  ground.y);
          var d = new Date();
          var timeJumping = d.getTime() - jumpTimerStart;

          var numChargeBars = timeJumping / 500;
          if (numChargeBars > chargeBars.length){
            var yOffset = calcChargeBarYOffset(chargeBars);
            var bar = new ex.Actor(jumper.x - jumper.width / 2, yOffset, 40, 10, ex.Color.Green);
            chargeBars.push(bar);
            game.addChild(bar);
          }
        }

        if(jumpAmount > 0) {
          jumper.rise(30);
          jumpAmount -= 30;
        }
        else if (!jumper.isOnGround()){
          jumper.fall(3)
        }
      });

      scoreLabel.addEventListener('update', function(evt){
        this.text = "Score: " + score;
      });

      ex.KeyDown()

      // Add an jumper to the current scene
      game.addChild(jumper);
      game.addChild(ground);
      game.addChild(scoreLabel);

      generateGoal();

      // Start the game
      game.start();
   </script>
</body>
</html>